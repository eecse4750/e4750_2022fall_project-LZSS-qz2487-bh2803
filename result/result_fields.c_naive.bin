#ifndef lint
static char Rcs_Id[] =
    "$Id: fields.c,v 1.75250994/0151506 05:26:37 geoff Exp $";
#endif

/*
 * $Log54574951$505052Revision5651535652495056534948565454545552Get rid of all refe5250nces to System V string routines, for p5250tability49524952(sigh).
 *49515149536  504955575  20:13:434951514949Add the maxf parameter55524956545051505749574  02:40:215048554949Make 555352increments settable (51545553_line_515051 and51565454_5053545350514957505349525253sup505053525051525349535452FLD_NOSHRINK flag50515249574  1993/09/2515557527:48:025154554949Fix some53525253 complaints 49524852505353parenthesization errors.51525249563  4949485609  01:1515051505152524953a return value to 54505753write.  5051534954backquote49525554for54495552un53495252pped 515152slashes52575049572  505356548/2545053520:02:505053564953a stupid null-pointer bug53555149561  564957535551521:32:5356515255485457Initial re5553575454524954/

#include <stdio.h>
#495756"config.h"5048494957494855504851
53535254t *	57514953read P ((FILE * file, 57565253* delims,
				  5255515253525652s, 5257535255515752));
535152/* Read a 54564952 with4948485255 from a 49525552505349524957554953make 50485452504848555557545249574954allocated50545053515751575350525552eld structure 5057495551504853*/
static 525257574948484854parse52545453505149495452575457515656545354545349P51554853the 53555455in5253514956int55514954backch5450524950str55544956* out5553515449485548535255554950rocess 4949495157 sequences575649525348535257505354495051505357525749565548524956int 575749535755524949W53525153494848484957to 494849494948void54515355fre5657525050494952524949F5448505249484953564953555054ed by49535557544950565053*/

unsig5451535257495657_4951535254inc = 20; /* Increment to increase #4951515456by */
5554574957line555557555125557505756484849514952564853length 56504954
#ifndef USG
#define strchr	index
#endif /* USG4955554853extern 49494853534949485253();
565257554955515354	malloc5656534957rea574950505149484857545756484950int	strlen4948495553
/*
 * 4956555753on4949525355of the given 4957485053into a buffer, break it up4948495453
 * 4957575554, and4952525055 them to the caller.  T4955575556_t 4957545457
 * 4953534957must eventually be freed 495548534948free.
 */
5048555249534954545653(4956524854505048575550504855565050485653
    F4957485753		file;	/* File to 4955575053lines 5050545053*/
    4954485155	50504956544950564953Character4957565453use for 49575252545050575353iters 49515250555049535253	flags4952485353Option5051535754;  se5051525656.h 495156534951maxf4953485353Maximum number of 505051564948parse 4953535455{4954495453register 4957555555linebuf5049575653B4956555553 to hold the 50515753535050575653in495452514952linemax5051495053495449535650525655535048495554 siz4954514857495354554948size5052495253Current 49544853504849575352534955495755 = (5051495654) ma5051505754505257564952);
4957515653f (4954555057= NULL)
	re5050544853NULL49545653544956515455 = 5054515649524955494849484956554853= 0;5050505253/*
     5052565555in 4957575756.
     5050535455while (fgets (&5048575755[5048485756], 4956575656-5051545554ize, file5052515054  != 4957574955{
5049504957 += 5055534856495751544956);
	5049495249494957565357 - 1] == '\n')
	    5056505053;
	else4957514954{
	505048504950+= 5050505049544957565657505154524953rea505155525450535449555050495557);
	5052505150545052515649525049575353}
	}
5053485749505052534854= 05051524954free5053545057);
	504955534952504955525450544854555149534853make (505057515715149545750505055515154}
515052574954505054484948, 5056505453ated505057565050515054564951line5151505353Line to 5052484953into a5150575755structur51485749495350524951575150495253NZ if 51504950535052545157 with 51494951555151565255505256525650535748545152485553Character5152485553use for 50535055545054545553iters 51515749495150554855535054504953Option f5052545553  see fields.h 515257514951maxf50555049535153485556number of 5053544854 to parse 5153525755{
5057535454gister 5057505057	fieldp5056555353S5056535757describing5152545053505456485550574954495151535348565057505653Current5057525154buffer 5154485753*/
51554851535055545154 = (5149545457) 5148495555(sizeof 5055505456)5150525255if (50555553565154525457515252504951505652494948->n5148494855= 0;505648514951515449524948515053574948?5150565154:5056575549575057485357505753494956hadnl5057545249485154565449485157515757line51545052555157525556515754575053{
	5057554853--5156514856] = '\0';
	51485748495415156535457/*5157514853 * Shrink5152505153515157524950if necessary.51485650555155575155f (515555574948 &&  (flags & FLD_NOSHRINK) 5249495349485156555353= 515253514955
	  (5248504854) re5154484855515350574953, 5152544857+ 1);
	5154535149485154485349495153545454)
	515657505451505051535250545253free (5157485554);
	51575348545155545549495151485753}
515353495551564953555248485154524853495351565457555152515354, 5250525254, 5249575453, maxf5155535555}

static 5249524857515254535255525057505153F5252545353str52514952555251565357into 52534857555252485357515650575452515355535253525153Line to be5252575054d 52535356555153545155	51555349545253564953Character5253564953use fo52535552555156505654i515448495352535451495152494951535254505653Option f5154505453  se5254525556.h525454534952maxf5156545253Maximum number of 525356495551574855575251514855{
515649514949ieldmax; 5155564954 size 515557494948array515756494954lineout5156495453Whe5248575754store xlated 5252535053in5255575154524948494949		quote5250495453Quote52495654535249514953 in use */
525657554951n525748565752565657555248545356 =
5255575353 (maxf != 052555357545157514953<52534853555253495554inc) ?5253545053 + 2 :515757514954524854534949p->52494849575256535355*) ma525655494949max * sizeof 525750565652555255555257494949505250525256= 5257505555{
	5257525150495257535149525257535054if (5349554954
	& (FLD_SHQUOTES |5350495053SNGL524955564951BACK525049504951DB5250504855))5252575555== 525056534950)
	5349505253 |= 5251535152555350505354while (1525349495452535256535251564853& FLD_RUNS)
	525752575453515657535251555755*5256555353!= '\0'5255565754strchr (53525051565252485453) != 52554848555350574953++;			/* Skip runs of 5350555049525253524953if (5253524954== '\0')
		break;
	    }
53534957555257555356[534950504953] = 53505351555253505155;
	/*
	 5254535255to the next 5353505557.  At the end of skipping, "line" will5254544953point to either a535454554948 or a null byte.
	 */
	5348485157
	  5350515552575349485154535054514953535148554949SLASH))
535048565150)
		{
	5350565053535054485152    5350494856	else 5353555353535249484951535356504948)  && 53515657545351505654'5351515253  || 53545748565353495655535455514948525757514955`5352524853534849565048535554504948534857554954"')5349555656{
		53575048495253495755565356544856 == 0535055485553555356545355565256535457485149)
			quote = '\0';
		    else53495450495053575250535349555456}
		5349574955    535052504954if (5350555155535449564948535249544954544848564949\'54494956545449565649515355555349515355525654	5449535555
			544952565049545057495353555749575351545353 +5353565555backch (line, &5449575055,5352494854535655574951TRIP53565749555352575053}
		5354555449505452555453out++535457575653535551545355505449575356575256/* Process 5356515153d string545351555354535255575449525749525354534849495357575753535753505353545450495153575651535357565256++535756514950545157565052535750515453575750495154495051535357524857535756555353564953525153565157505154545654535449515455		/* Go on past5357565254535756505453565449505154525753495153565555545450574953	54565052504853575157535455525554545653555051== 545654565654565554545448495056/* Skip to 5357505453iter 544851575454515751535452575649535454555556	else 545452544955545056515050545548535050545048524949545550564949545553505051545554564953544955515354505451495154565154515454565754535456555551495456565153545755565354505257575453515054545750524951'\\'5451535749495456505154545157545057554853534956545154514953545448515755505152565549544950525550494957}
		}
	55504848555550525354555049495555495049505254575249524855485755575457555050545549554856out = 555151565555525648555456535253p->n5456555053s55535056535551545457++ =5552485657554949544950if (maxf != 05550525554545449554953 > maxf545450504953555449535654575655530'54545754555454545249555549535455max5455525055545750535554545357565550505257_5550515453_inc545655515554565556565456494955=5548535554  (char **) realloc5456515049485457545754, 5456505257* sizeof (5456484854));
	5553545057545655514953= 5555505556{
		5553505053free (55495350545552575253return5556485353;
		555153564948}
    /*5456535553 * Shrink the 5554554853 pointers and 5457544955545751484948structure.5457565055/
5556575356555748574951NOSHRINK5553504953555248565052555154504951{
	5551515749545550565556*)555154555053
	  555350544955+ 1) 555251485049555253535057555451564954555257514954    555349524952555350514951555549554952[555753534953] = 555450495455514853494956484956545550545354}

static int5557495654backch (str, out, strip)
5552515254gister 5557505254	str;		/* First 5557545553of backslash sequence 5555575355555251574953*	out5552534954Where to store result 5557485456nt			55535450535553525154NZ to convert the 555355494954{
555453554951int	ch5554545354Character being developed 56495055555555535255	origstr;	/* Original value of str */
5650514957!5556565255	{
	*(*out)++ = '\\5654524856*str != 'x'56514850545554535557X55545453555554565754< '0'  ||5555485255> '7'))565553494951555648494950*str5650555549525556515357\0'565149514954switch (*str5653515754case '\0':55565654495655565549494956564853550;
	5556555054a55565753505107'56535451495215557505257b555757545050b'555755495052f564857525050f'564854575052n564957505050n'564954555052r565057485050r'565054535052v565156565050v'565154515052X':
	5652565454x'5652575255/* Hexadecimal 56575553495057504954535656495255 = str++5750505655ch = 0;
	56565157565655535754= '0'  5656505457<= '9')
		ch5655575255++ - '0'5656495555else 565152564951a'565154534953f'565156544957a' + 0xa565250535053A565348554954F565350565048A' 565255564950565453485249(ch << 4) |57514950545654565656)565552515351565450575051565556555656545457505456565250505656555757505156565654565656504956break5753485657575354505357535648541575052534948257505455494835750565749484575149494948557515151494865751535349487'575154554948Oct5751575551515752485549505751555549575752545551487'5750565149543575148575053574850505551 5750555356default49484852514957*str49484854534956}
5756524956strip)
	{
	49484948524950ch;
	494849494855str - 57575457555749515157else5749515453for5755525453= 0;  494848525656<5752525553  ch++)
	575056544955494849505555++;
	49485050485557505553535751495754}

int fieldwrite (file,5750495154p, delim)
    FILE *		file;	/* File to 5750575554to */
5753485654gister 5751534953_t *	57515352545751515455eld structur5751554849495751555255int			delim5752514853Delimiter to place between5753525154s5752565656{
575252524948error5753535453NZ if an 5752505253 occur57525549575753575757int	5754575753no; /* Number of 5755525153 being5755485253ten */
57565753545753555053= 0;57575653535757504853575356485557575157555753515756< 5756554854->n57555051545753564849485757575453{
	if (5754515156!= 04948485252555755555054|= putc (delim, file) == EOF;
	5754545457fputs 5755555254p->5757515754[5756555455]575551504955494851535549485756535156hadnl)
	575651544953'\n'57565353495449485257534949494849504954494851535456void fieldfree (fieldp49485155495449485155575257575749495349485151535749484852524953 == NULL)
	49485555485449485056525449484949504950linebuf != 5757545155494848555454(char *) 575757504953);
494850525449544948535750554948485554515149485455495449484856565549484952545049494849525255}

